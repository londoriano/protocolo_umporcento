<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protocolo 1% - Sistema de Maestria</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <style>
        :root {
            --bg-body: #121212;
            --bg-card: #1e1e1e;
            --bg-input: #2d2d2d;
            --text-main: #ffffff;
            --text-muted: #a0a0a0;
            --gold: #ffd700;
            --fire: #ff4500;
            --accent: #0d6efd;
        }

        body {
            background-color: var(--bg-body) !important;
            color: var(--text-main) !important;
            font-family: 'Segoe UI', sans-serif;
            overflow-x: hidden;
        }

        h1, h2, h3, h4, h5, p, span, div, label { color: var(--text-main); }
        .text-muted { color: var(--text-muted) !important; }

        .card, .modal-content, .list-group-item {
            background-color: var(--bg-card);
            border: 1px solid #333;
            color: var(--text-main);
        }

        .list-group-item { border-bottom: 1px solid #444; }

        .form-control {
            background-color: var(--bg-input) !important;
            border: 1px solid #444;
            color: #fff !important;
        }
        .form-control:focus {
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
            border-color: var(--accent);
        }

        .btn-close { filter: invert(1); }

        /* Streak (Sequência) Style */
        .streak-badge {
            background: linear-gradient(135deg, #ff4b1f, #ff9068);
            color: white;
            padding: 8px 16px;
            border-radius: 30px;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            box-shadow: 0 0 15px rgba(255, 75, 31, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.2s;
        }
        .streak-badge:hover { transform: scale(1.05); }
        .streak-badge i { margin-right: 6px; font-size: 1.2rem; }
        .streak-broken {
            background: #333;
            color: #888;
            box-shadow: none;
            border: 1px solid #444;
        }

        /* Pending Task */
        .pending-task-box {
            background-color: rgba(255, 193, 7, 0.1);
            border-left: 3px solid #ffc107;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
        }

        /* Animações */
        @keyframes pulse-gold {
            0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.4); border-color: var(--gold); }
            70% { box-shadow: 0 0 0 10px rgba(255, 215, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); border-color: var(--gold); }
        }
        .rank-up-anim { animation: pulse-gold 2s infinite; border: 1px solid var(--gold) !important; }
        
        .xp-badge-total {
            font-size: 0.9rem;
            background-color: #333;
            padding: 4px 10px;
            border-radius: 20px;
            border: 1px solid #555;
        }

        .sortable-ghost { opacity: 0.4; background-color: #333; border: 1px dashed #666; }
        .card { cursor: grab; }
        .card:active { cursor: grabbing; }
        .card button, .card i.bi-trash { cursor: pointer; }
    </style>
</head>
<body>

<div class="container py-5">
    <header class="mb-5 border-bottom border-secondary pb-3">
        <div class="row align-items-center g-3">
            <div class="col-md-5">
                <h1 class="display-6 fw-bold mb-0"><i class="bi bi-graph-up-arrow text-primary"></i> Protocolo 1%</h1>
                <p class="text-muted small mb-0">Consistência vence intensidade.</p>
            </div>
            
         <div class="col-md-2 text-md-center">
                <div id="streakDisplay" class="streak-badge streak-broken" title="Dias seguidos com pelo menos 1 tarefa">
                    <i class="bi bi-fire"></i> <span id="streakCount" class="mx-1">0</span> Dias
                </div>
            </div>

            <div class="col-md-5">
                <div class="d-flex flex-wrap gap-2 justify-content-md-end backup-controls align-items-center">
                    <input type="file" id="importFileInput" hidden accept=".json" onchange="importData(this)">
                    
                    <button class="btn btn-sm btn-outline-secondary" onclick="exportData()" title="Backup">
                        <i class="bi bi-download"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('importFileInput').click()" title="Restaurar">
                        <i class="bi bi-upload"></i>
                    </button>
                    <div class="vr bg-secondary mx-2"></div>
                    <button class="btn btn-sm btn-outline-light" onclick="openHistoryModal()">
                        <i class="bi bi-clock-history"></i> Log
                    </button>
                    <button class="btn btn-sm btn-primary" onclick="openSkillModal()">
                        <i class="bi bi-plus-lg"></i> Área
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div id="app-container"></div>
</div>

<div class="modal fade" id="historyModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Log de Execução</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <ul class="list-group list-group-flush" id="historyList"></ul>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="skillModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nova Área</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <label class="text-muted">Nome</label>
                <input type="text" id="skillNameInput" class="form-control" placeholder="Ex: Finanças">
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="addSkill()">Criar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="compModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nova Competência</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="currentSkillId">
                <label class="text-muted">Nome</label>
                <input type="text" id="compNameInput" class="form-control" placeholder="Ex: Investimentos">
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="addCompetence()">Adicionar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="createTaskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Comprometimento Diário</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="targetSkillId">
                <input type="hidden" id="targetCompId">
                <p class="text-muted small">Defina o que você vai fazer.</p>
                <input type="text" id="newTaskDesc" class="form-control" placeholder="Ex: Ler capítulo 3...">
            </div>
            <div class="modal-footer">
                <button class="btn btn-warning text-dark fw-bold" onclick="commitTask()">
                    <i class="bi bi-lock-fill"></i> Comprometer-se
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // --- STATE MANAGEMENT ---
    let data = [];
    let streak = { count: 0, lastDate: null };

    // Inicialização segura
    function init() {
        // Carrega Skills
        const storedData = localStorage.getItem('protocolo1data');
        if (storedData) data = JSON.parse(storedData);

        // Carrega Streak separado para compatibilidade ou objeto principal
        const storedStreak = localStorage.getItem('protocolo1streak');
        if (storedStreak) {
            streak = JSON.parse(storedStreak);
        }

        checkStreakIntegrity(); // Verifica se quebrou a sequência ao abrir
        render();
        updateStreakDisplay();
    }

    const RANKS = [
        { name: "Iniciante", minXp: 0, color: "#6c757d", icon: "bi-circle" },
        { name: "Aprendiz", minXp: 100, color: "#0dcaf0", icon: "bi-book" },
        { name: "Praticante", minXp: 500, color: "#198754", icon: "bi-hammer" },
        { name: "Especialista", minXp: 2000, color: "#0d6efd", icon: "bi-gem" },
        { name: "Mestre", minXp: 5000, color: "#dc3545", icon: "bi-lightning-charge-fill" },
        { name: "Grão Mestre", minXp: 10000, color: "#ffd700", icon: "bi-trophy-fill" }
    ];

    function getLocalDayKey(offsetDays = 0) {
        const d = new Date();
        d.setDate(d.getDate() + offsetDays);
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // --- STREAK LOGIC ---
    function checkStreakIntegrity() {
        const today = getLocalDayKey();
        const yesterday = getLocalDayKey(-1);

        // Se nunca houve atividade, streak é 0
        if (!streak.lastDate) return;

        // Se a última atividade não foi hoje nem ontem, quebrou.
        if (streak.lastDate !== today && streak.lastDate !== yesterday) {
            streak.count = 0;
            saveAll();
        }
    }

    function updateStreakOnFinish() {
        const today = getLocalDayKey();
        const yesterday = getLocalDayKey(-1);

        if (streak.lastDate === today) {
            // Já contou hoje, não faz nada
            return;
        }

        if (streak.lastDate === yesterday) {
            // Continuidade perfeita
            streak.count++;
        } else {
            // Começando ou Recomeçando (gap maior que 1 dia)
            streak.count = 1;
        }

        streak.lastDate = today;
        saveAll();
        updateStreakDisplay();
    }

    function updateStreakDisplay() {
        const el = document.getElementById('streakDisplay');
        const countEl = document.getElementById('streakCount');
        
        countEl.innerText = streak.count;

        // Visual check
        if (streak.count > 0) {
            el.classList.remove('streak-broken');
            // Verifica se a última atividade foi hoje para manter "aceso" ou "pendente" (opcional)
            // Aqui deixaremos aceso se count > 0
        } else {
            el.classList.add('streak-broken');
        }
    }

    // --- BACKUP ---
    function exportData() {
        if (data.length === 0 && streak.count === 0) return alert("Nada para exportar.");
        
        // Empacota tudo em um objeto V2
        const backupPackage = {
            version: "v7.0",
            skills: data,
            streak: streak
        };

        const dataStr = JSON.stringify(backupPackage, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `protocolo_full_backup_${getLocalDayKey()}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function importData(inputElement) {
        const file = inputElement.files[0];
        if (!file) return;
        if (!confirm("Isso substituirá TODOS os dados atuais (Skills e Streak). Continuar?")) {
            inputElement.value = '';
            return;
        }
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const json = JSON.parse(e.target.result);
                
                // Verifica formato
                if (Array.isArray(json)) {
                    // Formato Antigo (apenas skills)
                    data = json;
                    // Mantém o streak atual ou reseta? Vamos manter para ser gentil
                    alert("Backup antigo restaurado (Streak mantido do navegador atual).");
                } else if (json.version && json.skills) {
                    // Novo formato
                    data = json.skills;
                    streak = json.streak || { count: 0, lastDate: null };
                    alert("Backup completo restaurado!");
                } else {
                    throw new Error("Formato irreconhecível.");
                }

                saveAll();
                render();
                updateStreakDisplay();
            } catch (err) {
                alert("Erro: " + err.message);
            }
        };
        reader.readAsText(file);
        inputElement.value = '';
    }

    // --- CORE ---
    function saveAll() {
        localStorage.setItem('protocolo1data', JSON.stringify(data));
        localStorage.setItem('protocolo1streak', JSON.stringify(streak));
        // Não chamamos render() aqui para evitar loop infinito em updates visuais apenas
    }

    function getRank(xp) {
        for (let i = RANKS.length - 1; i >= 0; i--) {
            if (xp >= RANKS[i].minXp) return RANKS[i];
        }
        return RANKS[0];
    }
    function getNextRank(xp) {
        for (let i = 0; i < RANKS.length; i++) {
            if (xp < RANKS[i].minXp) return RANKS[i];
        }
        return null; 
    }

    // --- ACTIONS ---
    function openSkillModal() { new bootstrap.Modal(document.getElementById('skillModal')).show(); }
    
    function addSkill() {
        const name = document.getElementById('skillNameInput').value;
        if (!name) return;
        data.push({ id: Date.now(), name: name, competences: [] });
        document.getElementById('skillNameInput').value = '';
        bootstrap.Modal.getInstance(document.getElementById('skillModal')).hide();
        saveAll();
        render();
    }

    function openCompModal(skillId) {
        document.getElementById('currentSkillId').value = skillId;
        new bootstrap.Modal(document.getElementById('compModal')).show();
    }

    function addCompetence() {
        const skillId = parseInt(document.getElementById('currentSkillId').value);
        const name = document.getElementById('compNameInput').value;
        if (!name) return;
        const skill = data.find(s => s.id === skillId);
        skill.competences.push({ id: Date.now(), name: name, xp: 0, history: [], activeTask: null });
        document.getElementById('compNameInput').value = '';
        bootstrap.Modal.getInstance(document.getElementById('compModal')).hide();
        saveAll();
        render();
    }

    function openCreateTaskModal(skillId, compId) {
        document.getElementById('targetSkillId').value = skillId;
        document.getElementById('targetCompId').value = compId;
        document.getElementById('newTaskDesc').value = '';
        new bootstrap.Modal(document.getElementById('createTaskModal')).show();
    }

    function commitTask() {
        const skillId = parseInt(document.getElementById('targetSkillId').value);
        const compId = parseInt(document.getElementById('targetCompId').value);
        const desc = document.getElementById('newTaskDesc').value;
        if(!desc) return alert("Defina a tarefa.");
        
        const skill = data.find(s => s.id === skillId);
        const comp = skill.competences.find(c => c.id === compId);
        comp.activeTask = { desc: desc, date: getLocalDayKey() };
        
        bootstrap.Modal.getInstance(document.getElementById('createTaskModal')).hide();
        saveAll();
        render();
    }

    function finishTask(skillId, compId) {
        const skill = data.find(s => s.id === skillId);
        const comp = skill.competences.find(c => c.id === compId);
        if (!comp.activeTask) return;

        const oldRank = getRank(comp.xp);
        const now = new Date();
        
        // Histórico
        comp.history.push({
            task: comp.activeTask.desc,
            date: now.toISOString(),
            timestamp: now.toISOString(),
            completionDate: getLocalDayKey()
        });
        
        comp.xp += 10;
        comp.activeTask = null;

        // Atualiza STREAK
        updateStreakOnFinish();

        const newRank = getRank(comp.xp);
        saveAll();
        render();

        triggerConfettiMinor();
        if (newRank.name !== oldRank.name) {
            setTimeout(() => {
                alert(`SUBIU DE NÍVEL! ${newRank.name} em ${comp.name}`);
                triggerConfettiMajor();
            }, 300);
        }
    }

    function cancelTask(skillId, compId) {
        if(!confirm("Desistir?")) return;
        const skill = data.find(s => s.id === skillId);
        const comp = skill.competences.find(c => c.id === compId);
        comp.activeTask = null;
        saveAll();
        render();
    }

    function deleteSkill(id) {
        if(confirm("Excluir área?")) {
            data = data.filter(s => s.id !== id);
            saveAll();
            render();
        }
    }

    function deleteComp(skillId, compId) {
        if(confirm("Excluir competência?")) {
            const skill = data.find(s => s.id === skillId);
            skill.competences = skill.competences.filter(c => c.id !== compId);
            saveAll();
            render();
        }
    }

    function openHistoryModal() {
        const list = document.getElementById('historyList');
        list.innerHTML = '';
        let allHistory = [];
        data.forEach(skill => {
            if(skill.competences) skill.competences.forEach(comp => {
                if(comp.history) comp.history.forEach(entry => {
                    allHistory.push({
                        skillName: skill.name, compName: comp.name, task: entry.task, date: entry.timestamp || entry.date 
                    });
                });
            });
        });
        allHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
        const top50 = allHistory.slice(0, 50);
        if (top50.length === 0) list.innerHTML = '<li class="list-group-item text-center text-muted">Vazio.</li>';
        else top50.forEach(h => {
            const d = new Date(h.date);
            const str = d.toLocaleDateString('pt-BR') + ' ' + d.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});
            list.innerHTML += `<li class="list-group-item"><div class="d-flex justify-content-between"><span class="badge bg-secondary mb-1">${h.skillName} > ${h.compName}</span><small class="text-muted">${str}</small></div><div class="text-white">${h.task}</div></li>`;
        });
        new bootstrap.Modal(document.getElementById('historyModal')).show();
    }

    function triggerConfettiMinor() {
        confetti({ particleCount: 40, spread: 50, origin: { y: 0.7 }, colors: ['#0d6efd', '#fff'] });
    }
    function triggerConfettiMajor() {
        const end = Date.now() + 2000;
        (function frame() {
            confetti({ particleCount: 5, angle: 60, spread: 55, origin: { x: 0 }, colors: ['#ffd700'] });
            confetti({ particleCount: 5, angle: 120, spread: 55, origin: { x: 1 }, colors: ['#ffd700'] });
            if (Date.now() < end) requestAnimationFrame(frame);
        }());
    }

    // --- RENDER ---
    function render() {
        const container = document.getElementById('app-container');
        container.innerHTML = '';
        const todayKey = getLocalDayKey();

        if (data.length === 0) {
            container.innerHTML = `<div class="text-center text-muted mt-5 opacity-50"><i class="bi bi-clipboard-data fs-1"></i><p class="mt-2">Sem dados.</p></div>`;
            return;
        }

        data.forEach(skill => {
            const totalSkillXp = skill.competences ? skill.competences.reduce((acc, curr) => acc + (curr.xp || 0), 0) : 0;
            let compsHtml = '';

            if (skill.competences && skill.competences.length > 0) {
                skill.competences.forEach(comp => {
                    const rank = getRank(comp.xp);
                    const nextRank = getNextRank(comp.xp);
                    let progress = 100; 
                    let nextText = "Lenda";

                    if (nextRank) {
                        const total = nextRank.minXp - rank.minXp || 100;
                        const current = comp.xp - rank.minXp;
                        progress = Math.max(5, (current / total) * 100);
                        nextText = `Próximo: ${nextRank.minXp} XP`;
                    }

                    const lastHistory = comp.history.length ? comp.history[comp.history.length-1] : null;
                    let doneToday = false;
                    if (lastHistory) {
                        if (lastHistory.completionDate) doneToday = lastHistory.completionDate === todayKey;
                        else doneToday = lastHistory.date.startsWith(todayKey); 
                    }

                    let actionArea = '';
                    if (doneToday) {
                        actionArea = `<button class="btn btn-outline-success btn-sm w-100 disabled border-0 opacity-75"><i class="bi bi-check-all"></i> Feito Hoje</button>`;
                    } else if (comp.activeTask) {
                        actionArea = `<div class="pending-task-box"><small class="d-block text-warning mb-1"><i class="bi bi-hourglass-split"></i> Pendente</small><div class="fst-italic mb-2 text-white small">"${comp.activeTask.desc}"</div><div class="d-flex gap-2"><button class="btn btn-success btn-sm flex-grow-1" onclick="finishTask(${skill.id}, ${comp.id})"><i class="bi bi-check-lg"></i> Feito</button><button class="btn btn-outline-danger btn-sm" onclick="cancelTask(${skill.id}, ${comp.id})"><i class="bi bi-x-lg"></i></button></div></div>`;
                    } else {
                        actionArea = `<button class="btn btn-outline-primary btn-sm w-100" onclick="openCreateTaskModal(${skill.id}, ${comp.id})"><i class="bi bi-plus-circle"></i> Criar Tarefa</button>`;
                    }
                    
                    const borderClass = rank.minXp >= 10000 ? 'rank-up-anim' : '';

                    compsHtml += `
                    <div class="col-md-6 col-lg-4" data-id="${comp.id}">
                        <div class="card p-3 h-100 ${borderClass}">
                            <div class="d-flex justify-content-between mb-2">
                                <h5 class="fw-bold mb-0 text-white text-truncate"><i class="bi bi-grip-vertical text-muted me-1"></i>${comp.name}</h5>
                                <i class="bi bi-trash text-secondary small" style="cursor:pointer" onclick="deleteComp(${skill.id}, ${comp.id})"></i>
                            </div>
                            <div class="d-flex align-items-center mb-3">
                                <i class="${rank.icon} me-2 fs-4" style="color:${rank.color}"></i>
                                <div class="line-height-1">
                                    <div class="small text-muted text-uppercase" style="font-size:0.65rem">Rank</div>
                                    <div style="color:${rank.color}; font-weight:bold; font-size:0.9rem">${rank.name}</div>
                                </div>
                                <div class="ms-auto fw-bold text-light">${comp.xp} XP</div>
                            </div>
                            <div class="progress bg-dark mb-1" style="height:6px">
                                <div class="progress-bar" style="width: ${progress}%; background-color: ${rank.color}"></div>
                            </div>
                            <div class="text-end text-muted small mb-3 fst-italic" style="font-size:0.7rem">${nextText}</div>
                            <div class="mt-auto pt-2 border-top border-secondary border-opacity-25">${actionArea}</div>
                        </div>
                    </div>`;
                });
            } else {
                compsHtml = `<div class="col-12 text-muted fst-italic small">Adicione competências.</div>`;
            }

            container.innerHTML += `
            <div class="mb-5 fade-in">
                <div class="d-flex align-items-center mb-3 pb-2 border-bottom border-secondary border-opacity-25">
                    <h3 class="m-0 text-white fw-light fs-4">${skill.name}</h3>
                    <span class="ms-3 xp-badge-total text-warning"><i class="bi bi-lightning-fill"></i> ${totalSkillXp} XP</span>
                    <div class="ms-auto">
                        <button class="btn btn-sm btn-dark border-secondary me-1" onclick="openCompModal(${skill.id})"><i class="bi bi-plus"></i></button>
                        <button class="btn btn-sm btn-outline-danger border-0" onclick="deleteSkill(${skill.id})"><i class="bi bi-trash"></i></button>
                    </div>
                </div>
                <div class="row g-3 sortable-list" id="sortable-skill-${skill.id}">${compsHtml}</div>
            </div>`;
        });

        // Re-init Sortable
        data.forEach(skill => {
            const el = document.getElementById(`sortable-skill-${skill.id}`);
            if(el) {
                new Sortable(el, {
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    handle: '.card',
                    onEnd: function(evt) {
                        const newOrderIds = Array.from(evt.to.children).map(item => parseInt(item.getAttribute('data-id')));
                        const currentSkill = data.find(s => s.id === skill.id);
                        if(currentSkill && currentSkill.competences) {
                            const compMap = new Map(currentSkill.competences.map(c => [c.id, c]));
                            currentSkill.competences = newOrderIds.map(id => compMap.get(id)).filter(c => c !== undefined);
                            saveAll(); // Salva a ordem
                        }
                    }
                });
            }
        });
    }

    // Start
    init();

</script>
</body>
</html>